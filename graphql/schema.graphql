scalar Time
scalar JSON
scalar Any

# Workspace
type Workspace {
  id: String!
  name: String!
}

# Field type definitions
enum FieldType {
  TEXT
  NUMBER
  SELECT
  MULTI_SELECT
  USER
  MULTI_USER
  DATE
  URL
}

type FieldOption {
  id: String!
  name: String!
  description: String
  color: String
  metadata: JSON  # Arbitrary metadata (e.g., {"score": 4})
}

type FieldDefinition {
  id: String!
  name: String!
  type: FieldType!
  required: Boolean!
  description: String
  options: [FieldOption!]
}

type EntityLabels {
  case: String!
}

type FieldConfiguration {
  fields: [FieldDefinition!]!
  labels: EntityLabels!
}

# Custom field value
type FieldValue {
  fieldId: String!
  # Value encoded as JSON. Clients parse based on field type from FieldConfiguration.
  value: Any!
}

input FieldValueInput {
  fieldId: String!
  value: Any!
}

# Slack file attachment metadata
type SlackFile {
  id: String!
  name: String!
  mimetype: String!
  filetype: String!
  size: Int!
  urlPrivate: String!
  permalink: String!
  thumbURL: String
}

# Slack Message (stored in case sub-collection)
type SlackMessage {
  id: String!
  channelID: String!
  threadTS: String
  teamID: String!
  userID: String!
  userName: String!
  text: String!
  files: [SlackFile!]!
  createdAt: Time!
}

type SlackMessageConnection {
  items: [SlackMessage!]!
  nextCursor: String!
}

enum CaseStatus {
  OPEN
  CLOSED
}

# Entity types
type Case {
  id: Int!
  title: String!
  description: String
  status: CaseStatus!
  assigneeIDs: [String!]!
  assignees: [SlackUser!]!
  slackChannelID: String
  slackChannelName: String
  slackChannelURL: String
  fields: [FieldValue!]!       # Resolved from case_field_values via DataLoader
  actions: [Action!]!
  knowledges: [Knowledge!]!
  slackMessages(limit: Int, cursor: String): SlackMessageConnection!
  createdAt: Time!
  updatedAt: Time!
}

enum ActionStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  BLOCKED
  COMPLETED
}

type Action {
  id: Int!
  caseID: Int!
  case: Case
  title: String!
  description: String
  assigneeIDs: [String!]!
  assignees: [SlackUser!]!
  slackMessageTS: String
  status: ActionStatus!
  createdAt: Time!
  updatedAt: Time!
}

# Inputs
input CreateCaseInput {
  title: String!
  description: String
  assigneeIDs: [String!]
  fields: [FieldValueInput!]
}

input UpdateCaseInput {
  id: Int!
  title: String!
  description: String
  assigneeIDs: [String!]
  fields: [FieldValueInput!]
}

input CreateActionInput {
  caseID: Int!
  title: String!
  description: String
  assigneeIDs: [String!]
  slackMessageTS: String
  status: ActionStatus
}

input UpdateActionInput {
  id: Int!
  caseID: Int
  title: String
  description: String
  assigneeIDs: [String!]
  slackMessageTS: String
  status: ActionStatus
}

# Slack User
type SlackUser {
  id: String!
  name: String!
  realName: String!
  imageUrl: String
}

# Knowledge
type Knowledge {
  id: String!
  caseID: Int!
  case: Case
  sourceID: String!
  sourceURLs: [String!]!
  title: String!
  summary: String!
  sourcedAt: Time!
  createdAt: Time!
  updatedAt: Time!
}

type KnowledgeConnection {
  items: [Knowledge!]!
  totalCount: Int!
  hasMore: Boolean!
}

# Source types
enum SourceType {
  NOTION_DB
  SLACK
}

type Source {
  id: String!
  name: String!
  sourceType: SourceType!
  description: String!
  enabled: Boolean!
  config: SourceConfig!
  createdAt: Time!
  updatedAt: Time!
}

union SourceConfig = NotionDBConfig | SlackConfig

type NotionDBConfig {
  databaseID: String!
  databaseTitle: String!
  databaseURL: String!
}

type SlackConfig {
  channels: [SlackChannel!]!
}

type SlackChannel {
  id: String!
  name: String!
}

input CreateNotionDBSourceInput {
  name: String
  description: String
  databaseID: String!
  enabled: Boolean
}

input UpdateSourceInput {
  id: String!
  name: String
  description: String
  enabled: Boolean
}

type NotionDBValidationResult {
  valid: Boolean!
  databaseTitle: String
  databaseURL: String
  errorMessage: String
}

input CreateSlackSourceInput {
  name: String
  description: String
  channelIDs: [String!]!
  enabled: Boolean
}

input UpdateSlackSourceInput {
  id: String!
  name: String
  description: String
  channelIDs: [String!]
  enabled: Boolean
}

type SlackChannelInfo {
  id: String!
  name: String!
}

type Query {
  health: String!

  # Workspaces
  workspace(workspaceId: String!): Workspace!
  workspaces: [Workspace!]!

  # Cases
  cases(workspaceId: String!, status: CaseStatus): [Case!]!
  case(workspaceId: String!, id: Int!): Case

  # Actions
  actions(workspaceId: String!): [Action!]!
  action(workspaceId: String!, id: Int!): Action
  actionsByCase(workspaceId: String!, caseID: Int!): [Action!]!
  openCaseActions(workspaceId: String!): [Action!]!

  # Configuration
  fieldConfiguration(workspaceId: String!): FieldConfiguration!

  # Slack (not workspace-scoped)
  slackUsers: [SlackUser!]!
  slackJoinedChannels: [SlackChannelInfo!]!

  # Sources
  sources(workspaceId: String!): [Source!]!
  source(workspaceId: String!, id: String!): Source

  # Knowledge
  knowledge(workspaceId: String!, id: String!): Knowledge
  knowledges(workspaceId: String!, limit: Int, offset: Int): KnowledgeConnection!
}

type Mutation {
  noop: Boolean

  # Cases
  createCase(workspaceId: String!, input: CreateCaseInput!): Case!
  updateCase(workspaceId: String!, input: UpdateCaseInput!): Case!
  deleteCase(workspaceId: String!, id: Int!): Boolean!
  closeCase(workspaceId: String!, id: Int!): Case!
  reopenCase(workspaceId: String!, id: Int!): Case!

  # Actions
  createAction(workspaceId: String!, input: CreateActionInput!): Action!
  updateAction(workspaceId: String!, input: UpdateActionInput!): Action!
  deleteAction(workspaceId: String!, id: Int!): Boolean!

  # Sources
  createNotionDBSource(workspaceId: String!, input: CreateNotionDBSourceInput!): Source!
  createSlackSource(workspaceId: String!, input: CreateSlackSourceInput!): Source!
  updateSource(workspaceId: String!, input: UpdateSourceInput!): Source!
  updateSlackSource(workspaceId: String!, input: UpdateSlackSourceInput!): Source!
  deleteSource(workspaceId: String!, id: String!): Boolean!
  validateNotionDB(workspaceId: String!, databaseID: String!): NotionDBValidationResult!
}
