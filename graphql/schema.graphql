scalar Time
scalar JSON
scalar Any

# Field type definitions
enum FieldType {
  TEXT
  NUMBER
  SELECT
  MULTI_SELECT
  USER
  MULTI_USER
  DATE
  URL
}

type FieldOption {
  id: String!
  name: String!
  description: String
  color: String
  metadata: JSON  # Arbitrary metadata (e.g., {"score": 4})
}

type FieldDefinition {
  id: String!
  name: String!
  type: FieldType!
  required: Boolean!
  description: String
  options: [FieldOption!]
}

type EntityLabels {
  case: String!
}

type FieldConfiguration {
  fields: [FieldDefinition!]!
  labels: EntityLabels!
}

# Custom field value
type FieldValue {
  fieldId: String!
  # Value encoded as JSON. Clients parse based on field type from FieldConfiguration.
  value: Any!
}

input FieldValueInput {
  fieldId: String!
  value: Any!
}

# Entity types
type Case {
  id: Int!
  title: String!
  description: String!
  assigneeIDs: [String!]!
  assignees: [SlackUser!]!
  slackChannelID: String
  fields: [FieldValue!]!       # Resolved from case_field_values via DataLoader
  actions: [Action!]!
  knowledges: [Knowledge!]!
  createdAt: Time!
  updatedAt: Time!
}

enum ActionStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  BLOCKED
  COMPLETED
  ABANDONED
}

type Action {
  id: Int!
  caseID: Int!
  case: Case
  title: String!
  description: String!
  assigneeIDs: [String!]!
  assignees: [SlackUser!]!
  slackMessageTS: String
  status: ActionStatus!
  createdAt: Time!
  updatedAt: Time!
}

# Inputs
input CreateCaseInput {
  title: String!
  description: String!
  assigneeIDs: [String!]
  fields: [FieldValueInput!]
}

input UpdateCaseInput {
  id: Int!
  title: String!
  description: String!
  assigneeIDs: [String!]
  fields: [FieldValueInput!]
}

input CreateActionInput {
  caseID: Int!
  title: String!
  description: String!
  assigneeIDs: [String!]
  slackMessageTS: String
  status: ActionStatus
}

input UpdateActionInput {
  id: Int!
  caseID: Int
  title: String
  description: String
  assigneeIDs: [String!]
  slackMessageTS: String
  status: ActionStatus
}

# Slack User
type SlackUser {
  id: String!
  name: String!
  realName: String!
  imageUrl: String
}

# Knowledge
type Knowledge {
  id: String!
  caseID: Int!
  case: Case
  sourceID: String!
  sourceURL: String!
  title: String!
  summary: String!
  sourcedAt: Time!
  createdAt: Time!
  updatedAt: Time!
}

type KnowledgeConnection {
  items: [Knowledge!]!
  totalCount: Int!
  hasMore: Boolean!
}

# Source types
enum SourceType {
  NOTION_DB
  SLACK
}

type Source {
  id: String!
  name: String!
  sourceType: SourceType!
  description: String!
  enabled: Boolean!
  config: SourceConfig!
  createdAt: Time!
  updatedAt: Time!
}

union SourceConfig = NotionDBConfig | SlackConfig

type NotionDBConfig {
  databaseID: String!
  databaseTitle: String!
  databaseURL: String!
}

type SlackConfig {
  channels: [SlackChannel!]!
}

type SlackChannel {
  id: String!
  name: String!
}

input CreateNotionDBSourceInput {
  name: String
  description: String
  databaseID: String!
  enabled: Boolean
}

input UpdateSourceInput {
  id: String!
  name: String
  description: String
  enabled: Boolean
}

type NotionDBValidationResult {
  valid: Boolean!
  databaseTitle: String
  databaseURL: String
  errorMessage: String
}

input CreateSlackSourceInput {
  name: String
  description: String
  channelIDs: [String!]!
  enabled: Boolean
}

input UpdateSlackSourceInput {
  id: String!
  name: String
  description: String
  channelIDs: [String!]
  enabled: Boolean
}

type SlackChannelInfo {
  id: String!
  name: String!
}

type Query {
  health: String!

  # Cases
  cases: [Case!]!
  case(id: Int!): Case

  # Actions
  actions: [Action!]!
  action(id: Int!): Action
  actionsByCase(caseID: Int!): [Action!]!

  # Configuration
  fieldConfiguration: FieldConfiguration!

  # Slack
  slackUsers: [SlackUser!]!
  slackJoinedChannels: [SlackChannelInfo!]!

  # Sources
  sources: [Source!]!
  source(id: String!): Source

  # Knowledge
  knowledge(id: String!): Knowledge
  knowledges(limit: Int, offset: Int): KnowledgeConnection!
}

type Mutation {
  noop: Boolean

  # Cases
  createCase(input: CreateCaseInput!): Case!
  updateCase(input: UpdateCaseInput!): Case!
  deleteCase(id: Int!): Boolean!

  # Actions
  createAction(input: CreateActionInput!): Action!
  updateAction(input: UpdateActionInput!): Action!
  deleteAction(id: Int!): Boolean!

  # Sources
  createNotionDBSource(input: CreateNotionDBSourceInput!): Source!
  createSlackSource(input: CreateSlackSourceInput!): Source!
  updateSource(input: UpdateSourceInput!): Source!
  updateSlackSource(input: UpdateSlackSourceInput!): Source!
  deleteSource(id: String!): Boolean!
  validateNotionDB(databaseID: String!): NotionDBValidationResult!
}
